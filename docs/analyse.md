# Аудит проекта ZaVVetka

Дата аудита: 2026-02-08
Формат: read-only исследование репозитория без изменений кода

## Ключевые выводы (приоритетно)

### CRITICAL

1. Открытые API заметок без авторизации: любой, кто знает `uuid`, может читать/перезаписывать/удалять заметку (`src/index.ts:299`, `src/index.ts:329`, `src/index.ts:357`, `src/index.ts:417`).
2. Технический endpoint создания заметок публичный и без ограничений (`POST /api/notes`) (`src/index.ts:278`, `src/index.ts:365`).
3. В `.dev.vars.example` указаны значения формата реальных секретов (`.dev.vars.example:1`, `.dev.vars.example:2`). Требуется ротация секретов.

### HIGH

4. Проверка webhook secret фактически опциональна: если секрет пустой, защита отключается (`src/index.ts:131`).
5. Нет rate limiting и лимитов на размеры payload для `ciphertext`/`iv` (`src/index.ts:458`).
6. Риски гонок и потери консистентности на KV (`last-write-wins`, неатомарный `openCount`) (`src/index.ts:318`, `src/index.ts:322`, `src/index.ts:597`).
7. Автоудаление реализовано только на уровне поля `expiresAt`, без нативного TTL в KV (`src/index.ts:478`, `src/index.ts:598`).
8. Нет базовых security headers для HTML/API (CSP, Referrer-Policy и пр.) (`src/index.ts:79`, `src/index.ts:659`).

### MEDIUM

9. Уведомления с полным IP читателя несут privacy/compliance риск (`src/index.ts:310`, `src/index.ts:500`).
10. В редакторе возможен unhandled rejection при удалении заметки (`src/note-page.ts:244`, `src/note-page.ts:361`).
11. Нестрогий роутинг через `startsWith("/api/notes")` может приводить к лишним path-матчам (`src/index.ts:106`).
12. Нет CI, автотестов, линтинга, форматтера (в репозитории отсутствуют workflow/test-конфиги).

### LOW

13. Гигиена репозитория: `.gitignore` включает строку `.gitignore` (`.gitignore:7`), несогласованность lockfile-подхода.
14. Документация частично расходится с реализацией (заявления в `README.md:7` про защиту от скриншотов не подтверждаются кодом).
15. Лендинг содержит мертвый код/артефакты и внешний импорт шрифтов (privacy/perf) (`landing-pages/src/App.tsx:1`, `landing-pages/src/App.tsx:129`, `landing-pages/src/index.css:1`).

## План улучшений (по этапам)

## Этап 0: Срочная стабилизация безопасности (0-24 часа)

Цель: закрыть самые опасные векторы злоупотребления.

1. Ротировать `TELEGRAM_BOT_TOKEN` и `TELEGRAM_WEBHOOK_SECRET`.
2. Обновить `.dev.vars.example` на безопасные заглушки.
3. Отключить/закрыть публичный `POST /api/notes`.
4. Сделать `TELEGRAM_WEBHOOK_SECRET` обязательным для production.

Критерий готовности:
- Публичное создание заметок без авторизации невозможно.
- Текущие секреты заменены.

## Этап 1: Контроль доступа и защита API (1-3 дня)

Цель: исключить неавторизованное чтение/изменение/удаление заметок.

1. Ввести capability-token на операции `GET/PUT/DELETE/POST auto-delete`.
2. Ограничить размер полей `ciphertext`/`iv` и входных JSON.
3. Добавить rate limiting для `/api/notes/*` и `/telegram/webhook`.
4. Добавить security headers:
   - `Content-Security-Policy`
   - `X-Content-Type-Options: nosniff`
   - `Referrer-Policy`
   - `Permissions-Policy`

Критерий готовности:
- Все чувствительные endpoint защищены токеном.
- Есть предсказуемая защита от abuse и oversized payload.

## Этап 2: Консистентность данных и lifecycle заметок (2-4 дня)

Цель: устранить гонки и повысить надежность хранения.

1. Перенести stateful-операции в Durable Objects или добавить optimistic concurrency (версия/etag).
2. Для автоудаления использовать KV TTL (`expirationTtl`/`expiration`) как базовый механизм.
3. Уточнить семантику `onRead`, чтобы исключить неоднозначности при конкурентных чтениях.

Критерий готовности:
- Нет потери обновлений при параллельных операциях.
- Удаление по таймеру гарантировано на уровне хранилища.

## Этап 3: Инженерная дисциплина (1-2 дня)

Цель: повысить предсказуемость поставки и качества.

1. Добавить CI (например GitHub Actions): `typecheck + lint + tests` для всех подпроектов.
2. Ввести ESLint + Prettier и единые скрипты в корне.
3. Добавить минимальные тесты:
   - unit: валидация payload/режимов автоудаления/роутинг
   - integration: create/get/put/delete happy path + onRead/TTL кейсы
4. Зафиксировать lockfile-стратегию в монорепо.

Критерий готовности:
- Каждый PR проходит автоматические проверки.
- Ключевая бизнес-логика покрыта тестами.

## Этап 4: UX, privacy и документация (1-2 дня)

Цель: согласовать продуктовые обещания и поведение системы.

1. В `note-page` обработать ошибки удаления/сохранения без unhandled rejection.
2. Пересмотреть логику IP-уведомлений (маскирование, опциональность, disclosure).
3. Синхронизировать README/technical docs с фактической реализацией.
4. Очистить лендинг от неиспользуемого кода, улучшить accessibility и self-host шрифты при необходимости.

Критерий готовности:
- Документация соответствует коду.
- UI устойчив к сетевым ошибкам и прозрачнее для пользователя.

## Рекомендуемый порядок внедрения

1. Этап 0
2. Этап 1
3. Этап 2
4. Этап 3
5. Этап 4

## Быстрые метрики успеха

1. Ноль неавторизованных операций с заметками в логах.
2. Ноль инцидентов из-за утечки/компрометации секретов.
3. Стабильные проверки CI на каждом PR.
4. Снижение пользовательских ошибок в редакторе при нестабильной сети.
